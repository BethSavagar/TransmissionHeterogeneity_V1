---
title: "individual-based-model-test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
```

**Method:**

Following the Reed-Frost method an individual-based model is developed which simulates the likelihood of a susceptible individual becoming infected in any given generation using the binomial distribution. 

- The probability of a susceptible individual becoming infected **(S --> I)** in a given generation is calculated as: $r = 1-(1-p)^I$ where $p$ is the risk of infection of a susceptible by an infective, and $I$ is the number of infectives in the current generation. 
- For each susceptible individual in each generation a Bernouilli trial is conducted which determines whether the individual is infected, or not.


**Assumptions of the Reed Frost model:**  

- Fixed length infectious period: each generation lasts the same length of time as the infectious period, which is constant for all cases
- Life-long immunity: Once recovered individuals are immune for life and cannot be re-infected
- Homogeneous risk of infection: Each susceptible individual has the same risk of infection from a given infected individual. The `p_transmission` parameter is constant.  
- *Note: This will need to change when modelling a heterogeneous population, perhaps by generating a new 'p' value for each individual, taken from a gamma / negative binomial distribution?*


**Function**  

Create a function which takes as input a vector containing the states (S, I, R) of each individual in the population  and produces a new vector containing the state (S, I, R) of each individual in the next generation

Inputs:

- `state_vector` : a vector containing the disease state of each individual in the population in the current generation
- `p_transmission` : the probability of infection of a susceptible individual by an infected individual

Function start:

- `seed` variable created which contains the number of infected individuals in the current generation 
- Calculate r where $r = 1-(1-p)^I$ : the probability of a susceptible becoming infected in a given generation given the p_transmission parameter (p) and seed parameter (I)
- Create an empty vector (of length equal to population size) which will store the state of all individuals in the new generation (i.e. the function output)

FOR loop: 

- A for loop is written which iterates along each individual in the population and simulates their change of state (or not) depending on the individual's state (S I, R) in the current generation. 
- If an individual has state **S** in the current generation, the probability of a change of state from **S --> I** is calculated using the binomial distribution (Bernouilli Trial) *Note: the output of the bernouilli trial will be 0, if the state is unchanged (individual remains S) and 1 if state is changed (individual becomes I)*
- If an individual has state **I** in the current generation, their state changes to **R** in the next generation (since each generation is the length of the infectious period)
- If an individual has state **R** in the current generation, their state remains as **R** in the next generation since infection confers lifelong immunity.
- The state of the individual in the next generation is held in the variable `new_state` as either **0, 1 or 2** coding disease states **S, I, R** respectively
- The vector `new_state_vec` is updated to reflect the new state of all individuals in the population, in the next generation, coded as **0,1,2** for states **S, I, R** respectively.
- The `new_state_vec` is updated to contain the disease states of all individuals in the population in the next generation, coded as S, I, R to match the input vector.




```{r}

## Function inputs: ##
# state_vector: A vector containing the disease state for each individual in a population
# p_transmission: The probability of transmission

change_state <- function(state_vector, 
                         p_transmission){
  
  # Calculation of r, the risk of a susceptible becoming infected in a given generation
  # r depends on the probability of transmission (p_transmission) and number of infectives in the current generation (seed)
  
  seed <- length(state_vector[state_vector == "I"]) # the number of infected individuals in the current generation
  r <- 1 - (1 - p_transmission)^seed # the probability of a susceptible individual becoming infected in a given generation
  
  new_state_vec <- vector(length = length(state_vector)) # A vector to store the new disease states for all individuals in the population
  
  for (i in 1:length(state_vector)) { # iterating over each individual in the population
    
    # IF an individual's state is S then run simulation to determine whether the individual becomes infected by a Bernouilli Trial (binomial distribution) with probability of infection, r. 
    
    if (state_vector[i] == "S") { 
      new_state <- rbinom(1, 1, r) # r is the likelihood of becoming infected, size = 1 (since 1 individual is being considered), n = 1 (since 1 trial)
      # the new_state variable codes an individual's state as 0 (if unchanged, S) and 1 (if changed, I)
      
    } else if (state_vector[i] == "I" | state_vector[i] == "R") { # If an individual's state is either I or R then the new state will be R
      new_state <- 2 # the new_state variable codes an individual's state as 2, denoting R
    
    }
    # Update the new_state_vec vector to contain the state of all individuals in the population in the new generation, coded as 0,1,2 for S,I,R states respectively.
    
    new_state_vec[i] <- new_state 
  }
  
  # Recode the new_state_vec vector such that 0,1,2 are replaced with strings S, I, R, as in the input state_vector, for future useability (see example below)
  
  new_state_vec[new_state_vec == 0] <- "S"
  new_state_vec[new_state_vec == 1] <- "I"
  new_state_vec[new_state_vec == 2] <- "R"
  
  return(new_state_vec) # output is the new_state_vec which contains the state of all individuals in the new generation
}


```



## Example

In the example the disease state of individuals in a population of 100 is simulated over 20 generations, given a single initial index case.

```{r}


N <- 100 # Population size
I0 <- 1 # Index case

init_state <- c(rep("I", length(I0)), 
                rep("S", N - length(I0))
                ) # A vector containing the state of all individuals in the populationL: a single index case (I0) and the remaining all susceptible

p_transmission <- 0.5 # 50% probability of transmission - high to check functionality!


# Test 1, given an initial state vector, the change state function will produce a vector containing the state of all individuals in the next generation

state2 <- change_state(init_state, p_transmission)
head(cbind(init_state, state2))


# Test 2, simulate the change in state of all individuals in the population over 20 generations, create a matrix to contain the state change.

generations <- 20 # number of generations to simulate

state_tracker <- matrix(nrow = N, ncol = 1+generations) # a matrix to contain the disease state of all individuals over 20 generations, ncol = 1 + generations with first col containing initial states

state_tracker[,1] <- init_state # first col contains initial state of individuals in population

# A for loop to fill the state_tracker matrix
for(i in 2:ncol(state_tracker)){ # iterate over each generation of individuals
  
  current_state <- state_tracker[,i-1] # update the current state vector to reflect the state in the current generation 
  I0 <- length(current_state[current_state == "I"]) # the seed is the number of infectives in the current generation (held in current_state)
  new_state <- change_state(current_state, p_transmission) # use the change_state function to update the state of the individuals in the population, new_state is a vector containing disease states of all individuals in the new generation
  state_tracker[, i] <- new_state # update the state_tracker matrix with the new_state vector for the new generation
  
}

head(state_tracker)

```


