---
title: "NBD heterogeneity model example"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

A markdown file which explains the steps and gives an example of a heterogeneous epidemic model, based on code from Althaus (2005). 

Set up: 

```{r eval = FALSE}
#load the fitdistrplus package for fitting data to distributions
library(fitdistrplus) 
```

### Step 1: Defining R and k for modelling overdispersion


In Althaus (2005) empirical outbreak data from a well characterised Ebola outbreak (involving 152 individuals) is used to estimate R and k by fitting to a negative binomial distribution as follows: 

- Create a vector (c0) which contains the number of secondary cases produced by each of the 152 infected individuals
```{r eval = FALSE}

# Set n to the number of cases in the outbreak, n = 152.
n <- 152 

# Create a vector (c1) containing the secondary cases for 43 individuals which caused onward transmission (i.e. secondary cases > 0 )
c1 <- c(1,2,2,5,14,1,4,4,1,3,3,8,2,1,1,4,9,9,1,1,17,2,1,1,1,4,3,3,4,2,5,1,2,2,1,9,1,3,1,2,1,1,2)

# Concatenation of vector c1 (secondary cases from 43, non-zero individuals) with the remainder of individuals (n = 152 - 43) who produced no secondary cases
c0 <- c(c1, rep(0, n-length(c1)))

```

- Use `fitdist()` from the `fitdistr` package to fit the secondary case data to a negative binomial distribution, producing an estimate for the mean R and k, the dispersion parameter.

```{r eval = FALSE}

# fitting the secondary case data contained in c0 to the negative binomial (nbinom) distribution
fit.cases <- fitdist(c0, "nbinom")

# The mean R is contained within mu estimate and for the dispersion parameter (k) is contained within the size estimate
summary(fit.cases)
dispersion <- summary(fit.cases)$estimate[1] #dispersion estimate
mean_R <- summary(fit.cases)$estimate[2] #R estimate

```


### Step 2: Define the serial interval distribution

Althaus (2005) also uses empirical data of the average serial intervals for Ebola using WHO data, fitted to a gamma distribution, prividing the parameters to define the gamma distribution from which serial intervals will be sampled.

- Create a vector which contains the observed serial intervals for 92 cases (from WHO data) within the range 0 - 43 (max serial interval)
- Fit the serial interval data to a gamma distribution using the `fitdist()` function, producing the parameters (shape and rate) required to define the gamma distribution which serial intervals will be sampled from

```{r eval = FALSE}
# Range of reported serial intervals for EBOLA cases
days <- 0:43

# Frequency of serial intervals between 0 - 43 days
frequency <- c(0,1,3,1,4,1,6,1,2,2,11,6,0,1,10,3,5,8,4,3,3,1,
               0,2,0,2,0,3,1,1,1,0,0,0,0,0,2,0,1,0,1,1,0,1)

# Create a vector of serial intervals for each of 92 cases using the frequency of serial intervals vector.
d <- rep(days,frequency) 
mean(d) #the mean serial interval

# Fit serial interval data to the gamma distribution to produce estimates for the shape and rate parameters required for gamma distribution definition & sampling
fit.serial <- fitdist(d, "gamma")
summary(fit.serial)

```

### Step 3: Stochastic simulations

*Description*
- A for loop is set up to run the model for the number of simulations specified
- For each run, the initial case number (index case) is 1 i.e. the seed, defined outside the for loop
- A vector `t` is initiated which contains the time to infection of each case in a given generation (e.g. t = 0 for index case)
- A vector `times` is defined which contains the time to infection for each case in a given outbreak i.e. from the index case (t=0), to every case in each successive generation. 
* Note: hence the length of times gives the total number of cases in an outbreak, and the max number in times gives the longest branch of the outbreak which corresponds to outbreak duration *


- A while loop is set up which simulates the branching process from the initial index case. 
- The number of secondary cases is stored in the vector `secondary` and generated using  `rnbinom()` with the mean R and k parameters. 
- The serial interval to each secondary infectiongenerated using `rgamma()` with the shape and rate parameters specified.
- The `t.new` vector contains the total time from the index case (t=0) to infection of each secondary case i n the current generation
- The `cases` vector is updated to reflect the number of cases generated in a given generation i.e. the length of the t.new vector
- The `t` vector is updated to contain the 'time-to-infection' of each case in the current generation (`t.new`)
- The `times` vector is updated, adding the duration data for each secondary case in the current generation, stored in `t.new`
- The while loop runs on the condition that the number of cases is > 0 (i.e. outbreak has not become extinct). When the number os cases = 0 the loop is broken.
- Outside the while loop the outbreak information is used to plot a graph of outbreak duration and cumulative number of cases, using the times vector. The `sims` matrix is also updated with the same information.



- Setup: Random sampling, number of simulations and initial cases

```{r eval = FALSE}

# Set seed to ensure reproducibility of code, this will be used for random sampling from the defined negative binomial distribution to generate secondary cases.
set.seed(645)

# Set the number of simulations (i.e. 1000 simulated importations)
runs <- 10

# Set the number of initial cases (i.e. a single imported case)
seed <- 1 

```

- Define a matrix to contain outbreak data (duration and case numbers) for each simulation

```{r eval= FALSE}

# Matrix dimensions: rows should reflect the number of simulations, 3 columns for the simulation index, outbreak duration and total case count

sims <- matrix(nrow = runs, ncol = 3)
colnames(sims) <- c("simulation", "duration", "cases")

```

- Run the model:

```{r eval = FALSE}

#A for loop is set up to run the model for the number of simulations specified (in runs)

for(i in 1:runs){
  
  # for each simulation set the initial case number (cases) to the number of seed infections, stored in seed vector outside for loop
  cases <- seed
  
  # set t = 0 for all seed infections, i.e. the time-to-infection of the index cases is 0
  t <- rep(0, seed)
  
  # set the times vector equal to t, to contain the time-to-infection for every case in the outbreak
  times <- t
  
  # Set up a while loop to simulate the branching process from the initial seed infection/s
  while(cases >0){
    
    # Generate the number of secondary cases produced by each seed case using the negative binomial
    secondary <- rnbinom(cases, 
                         size = fit.cases$estimate[1], # the dispersion parameter, k 
                         mu = fit.cases$estimate[2]) # the mean R
    #initiate vector to store time-to-infection for secondary cases
    t.new <- numeric()
    
    # Set up a for loop to calculate the time-to-infection for each secondary case using serial intervals sampled from the gamma distribution
    for(j in 1:length(secondary)){
      t.new <- c(t.new, 
                 t[j]+rgamma(secondary[j], 
                             shape = fit.serial$estimate[1],
                             rate = fit.serial$estimate[2]
                             )
                 )
    }
    cases <- length(t.new)
    t <- t.new
    times <- c(times, t.new)
      
  }
  
  
  A while loop is set up which simulates the branching process from the initial index case. 
- The number of secondary cases is stored in the vector `secondary` and generated using  `rnbinom()` with the mean R and k parameters. 
- The serial interval to each secondary infectiongenerated using `rgamma()` with the shape and rate parameters specified.
- The `t.new` vector contains the total time from the index case (t=0) to infection of each secondary case i n the current generation
  
}




```